<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de ConexiÃ³n - Frontend Backend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .test h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.success {
            background: #10b981;
            color: white;
        }
        
        .status.error {
            background: #ef4444;
            color: white;
        }
        
        .status.loading {
            background: #f59e0b;
            color: white;
        }
        
        button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Prueba de ConexiÃ³n Frontend-Backend</h1>
        
        <div class="test">
            <h3>1. Backend Health Check</h3>
            <p>Verificando si el backend estÃ¡ disponible...</p>
            <span id="health-status" class="status loading">Verificando...</span>
        </div>
        
        <div class="test">
            <h3>2. CORS Configuration</h3>
            <p>Verificando configuraciÃ³n de CORS...</p>
            <span id="cors-status" class="status loading">Verificando...</span>
        </div>
        
        <div class="test">
            <h3>3. Login Test</h3>
            <p>Intentando login con credenciales admin...</p>
            <span id="login-status" class="status loading">Verificando...</span>
        </div>
        
        <div class="test">
            <h3>4. Operaciones Test</h3>
            <p>Cargando operaciones activas...</p>
            <span id="operations-status" class="status loading">Verificando...</span>
        </div>
        
        <button onclick="runAllTests()">ğŸ”„ Ejecutar Todas las Pruebas</button>
        
        <div class="console" id="console"></div>
    </div>

    <script>
        function getApiBaseUrl() {
            if (typeof API_URL === 'string' && API_URL) {
                return `${API_URL.replace(/\/$/, '')}/api`;
            }

            const { protocol, hostname, port, origin } = window.location;
            if (protocol === 'http:' && port === '8000') {
                return `${protocol}//${hostname}:5000/api`;
            }
            return `${origin}/api`;
        }

        const API_BASE_URL = getApiBaseUrl();
        
        function log(message) {
            const console = document.getElementById('console');
            console.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        async function testHealth() {
            const status = document.getElementById('health-status');
            status.className = 'status loading';
            status.textContent = 'Probando...';
            
            try {
                log('ğŸ“¡ Enviando request a /api/health...');
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Backend respondiÃ³: ${JSON.stringify(data)}`);
                    status.className = 'status success';
                    status.textContent = 'âœ… Disponible';
                    return true;
                } else {
                    log(`âŒ Backend respondiÃ³ con status ${response.status}`);
                    status.className = 'status error';
                    status.textContent = 'âŒ Error';
                    return false;
                }
            } catch (error) {
                log(`âŒ Error de conexiÃ³n: ${error.message}`);
                status.className = 'status error';
                status.textContent = 'âŒ Error';
                return false;
            }
        }
        
        async function testCORS() {
            const status = document.getElementById('cors-status');
            status.className = 'status loading';
            status.textContent = 'Probando...';
            
            try {
                log('ğŸ” Verificando headers CORS...');
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:8000',
                        'Access-Control-Request-Method': 'GET'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };
                
                log(`âœ… Headers CORS: ${JSON.stringify(corsHeaders)}`);
                
                if (corsHeaders['Access-Control-Allow-Origin']) {
                    status.className = 'status success';
                    status.textContent = 'âœ… Configurado';
                    return true;
                } else {
                    status.className = 'status error';
                    status.textContent = 'âŒ No configurado';
                    return false;
                }
            } catch (error) {
                log(`âŒ Error CORS: ${error.message}`);
                status.className = 'status error';
                status.textContent = 'âŒ Error';
                return false;
            }
        }
        
        async function testLogin() {
            const status = document.getElementById('login-status');
            status.className = 'status loading';
            status.textContent = 'Probando...';
            
            try {
                log('ğŸ”‘ Intentando login...');
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@dsairsofteam.local',
                        password: 'Admin123!'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Login exitoso. Token recibido: ${data.token.substring(0, 20)}...`);
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    status.className = 'status success';
                    status.textContent = 'âœ… Login exitoso';
                    return true;
                } else {
                    const error = await response.json().catch(() => ({}));
                    log(`âŒ Login fallido: ${error.error || 'Error desconocido'}`);
                    status.className = 'status error';
                    status.textContent = 'âŒ Login fallido';
                    return false;
                }
            } catch (error) {
                log(`âŒ Error de login: ${error.message}`);
                status.className = 'status error';
                status.textContent = 'âŒ Error';
                return false;
            }
        }
        
        async function testOperations() {
            const status = document.getElementById('operations-status');
            status.className = 'status loading';
            status.textContent = 'Probando...';
            
            try {
                log('ğŸ“‹ Cargando operaciones activas...');
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/operations/active`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Operaciones cargadas: ${data.length} operaciÃ³n(es)`);
                    status.className = 'status success';
                    status.textContent = 'âœ… Funciona';
                    return true;
                } else {
                    log(`âŒ Error: Status ${response.status}`);
                    status.className = 'status error';
                    status.textContent = 'âŒ Error';
                    return false;
                }
            } catch (error) {
                log(`âŒ Error: ${error.message}`);
                status.className = 'status error';
                status.textContent = 'âŒ Error';
                return false;
            }
        }
        
        async function runAllTests() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            log('ğŸš€ Iniciando pruebas de conexiÃ³n...');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            await testHealth();
            log('');
            await testCORS();
            log('');
            await testLogin();
            log('');
            await testOperations();
            
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            log('âœ… Pruebas completadas');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }
        
        // Ejecutar pruebas automÃ¡ticamente al cargar
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
